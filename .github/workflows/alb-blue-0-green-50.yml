name: ALB - Set Listener Rule Blue Weight to 0%

on:
  workflow_dispatch:

env:
  RULE_ARN: "arn:aws:elasticloadbalancing:ap-southeast-1:697520799379:listener-rule/app/test-alb/7fca80a29e4e9f42/e04a11deb84d8779/f4dfc6fa5477d063"
  BLUE_TG_ARN: "arn:aws:elasticloadbalancing:ap-southeast-1:697520799379:targetgroup/blue-tg/d86491da42165227"
  GREEN_TG_ARN: "arn:aws:elasticloadbalancing:ap-southeast-1:697520799379:targetgroup/green-tg/496d47e4cc035626"

jobs:
  set-rule-blue-weight-zero:
    runs-on: ubuntu-latest
    environment:
      name: eks-rule-blue-weight-change

    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Create Forward Config JSON
        run: |
          cat > forward.json <<'EOF'
          [
            {
              "Type": "forward",
              "ForwardConfig": {
                "TargetGroups": [
                  {
                    "TargetGroupArn": "$BLUE_TG_ARN",
                    "Weight": 0
                  },
                  {
                    "TargetGroupArn": "$GREEN_TG_ARN",
                    "Weight": 100
                  }
                ]
              }
            }
          ]
          EOF
          
          # Substitute environment variables
          envsubst < forward.json > forward_final.json
          
          echo "=== Forward Config JSON ==="
          cat forward_final.json
          echo "==========================="

      - name: Modify Listener Rule Weights
        run: |
          echo "=== Rule ARN ==="
          echo "$RULE_ARN"
          echo "==============="
          
          echo "=== Verifying ARN format ==="
          echo "$RULE_ARN" | grep -E '^arn:aws:elasticloadbalancing:[a-z]{2}-[a-z]+-[0-9]+:[0-9]+:listener-rule/app/[a-zA-Z0-9-]+/[a-f0-9]{16,36}/[a-f0-9]{16,36}$' && echo "ARN format is valid" || echo "ARN format is invalid"
          echo "============================"
          
          echo "=== Forward JSON Content ==="
          cat forward_final.json
          echo "==========================="
          
          echo "=== Executing AWS CLI command ==="
          aws elbv2 modify-rule \
            --rule-arn "$RULE_ARN" \
            --actions file://forward_final.json
          
          echo "=== Listener rule modified successfully ==="
        env:
          RULE_ARN: ${{ env.RULE_ARN }}
